<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">src/api/request/adapter/XMLHttpRequestAdapter.js | playerme-core: 0.4.0 API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/UnofficialPlayerMe/playerme-core" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">api/auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/auth/AuthService.js~AuthService.html">AuthService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/auth/OAuthSessionModel.js~OAuthSessionModel.html">OAuthSessionModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/auth/OAuthSessionResponse.js~OAuthSessionResponse.html">OAuthSessionResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-authService">authService</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">api/request</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/APIService.js~APIService.html">APIService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aPIService">aPIService</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">api/request/adapter</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/adapter/AbstractRequestAdapter.js~AbstractRequestAdapter.html">AbstractRequestAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/adapter/JSONPRequestAdapter.js~JSONPRequestAdapter.html">JSONPRequestAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/adapter/NodeRequestAdapter.js~NodeRequestAdapter.html">NodeRequestAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/adapter/XMLHttpRequestAdapter.js~XMLHttpRequestAdapter.html">XMLHttpRequestAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-jSONPRequestAdapter">jSONPRequestAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-xMLHttpRequestAdapter">xMLHttpRequestAdapter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">api/request/response</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/AbstractResponse.js~AbstractResponse.html">AbstractResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/CollectionResponse.js~CollectionResponse.html">CollectionResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/EntityResponse.js~EntityResponse.html">EntityResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/ErrorResponse.js~RawResponse.html">RawResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/PagerData.js~PagerData.html">PagerData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/request/response/RawResponse.js~RawResponse.html">RawResponse</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">api/users</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/users/UserCollectionResponse.js~UserCollectionResponse.html">UserCollectionResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/users/UserEntityResponse.js~UserEntityResponse.html">UserEntityResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/users/UsersRepository.js~UsersRepository.html">UsersRepository</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-usersRepository">usersRepository</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/activity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/activity/ActivityModel.js~ActivityModel.html">ActivityModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/activity/ActivityPostData.js~ActivityPostMetaData.html">ActivityPostMetaData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/activity/ActivityVideoData.js~ActivityVideoData.html">ActivityVideoData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/activity/comment</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/activity/comment/CommentMeta.js~CommentMeta.html">CommentMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/activity/comment/CommentModel.js~CommentModel.html">CommentModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/game</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/game/GameExtendedModel.js~GameCompany.html">GameCompany</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/game/GameExtendedModel.js~GameExtendedModel.html">GameExtendedModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/game/GameExtendedModel.js~GamePlatform.html">GamePlatform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/game/GameMetadataModel.js~GameMetadataModel.html">GameMetadataModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/game/GameModel.js~GameModel.html">GameModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/notification</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/notification/NotificationModel.js~NotificationModel.html">NotificationModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/user</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/user/UserExtendedModel.js~UserExtendedModel.html">UserExtendedModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/user/UserModel.js~UserModel.html">UserModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">realtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/RealTimeService.js~RealTimeService.html">RealTimeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/Sails.js~Sails.html">Sails</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">realtime/api</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/api/AbstractRealTimeAPI.js~AbstractRealTimeAPI.html">AbstractRealTimeAPI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/api/RealTimeResponse.js~RealTimeResponse.html">RealTimeResponse</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">realtime/api/feed</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/api/feed/FeedRealTime.js~FeedRealTime.html">FeedRealTime</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">realtime/api/notifications</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/realtime/api/notifications/NotificationsRealTime.js~NotificationsRealTime.html">NotificationsRealTime</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/api/request/adapter/XMLHttpRequestAdapter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import AbstractRequestAdapter from &apos;./AbstractRequestAdapter&apos;;
import RawResponse from &apos;../response/RawResponse&apos;;
import AuthService from &apos;../../../api/auth/AuthService&apos;;
import ErrorResponse from &apos;../response/ErrorResponse&apos;;

// &lt;editor-fold desc=&quot;Login: Helpers&quot;&gt;

/**
 *
 * @param {string} url
 * @returns {{protocol:string, host:string, path:string, query:string}}
 * @ignore
 */
function parseUrl(url){
    var response = {};

    // Get protocol
    // &apos;http://google.com/a/b?c=d&apos; =&gt; [&apos;http&apos;, &apos;google.com/a/b?c=d&apos;]
    var split = url.split(&apos;://&apos;, 2);
    if (split.length &lt; 2) {
        throw new Error(&quot;Invalid URL in XHR passed to XMLHttpRequestAdapter&apos;s getURLObjectFromXHR [&quot;+url+&quot;]&quot;);
    }
    response.protocol = split[0];

    // Get host
    // &apos;google.com/a/b?c=d&apos; =&gt; [&apos;google.com&apos;, &apos;a/b?c=d&apos;]
    split = split[1].split(&apos;/&apos;, 2);
    if (split.length &lt; 2) {
        throw new Error(&quot;Invalid URL in XHR passed to XMLHttpRequestAdapter&apos;s getURLObjectFromXHR [&quot;+url+&quot;]&quot;);
    }
    response.host = split[0];

    // Get path
    // &apos;a/b?c=d&apos; =&gt; [&apos;a/b&apos;, &apos;c=d&apos;]
    split = split[1].split(&apos;?&apos;, 2);
    response.path = split[0];

    // Get query string
    response.query = split[1];

    return response;
}

/**
 * Takes a XMLHttpRequest and returns the headers in key-value pairs.
 * @param {XMLHttpRequest} XHR
 * @returns {Object.&lt;string,string&gt;}
 * @ignore
 */
function getHeadersFromXHR(XHR){
    var result = {};
    var headers = XHR.getAllResponseHeaders().split(&apos;\u000d\u000a&apos;);
    for (var i=0; i &lt; headers.length; i++){
        var split = headers[i].split(&apos;: &apos;, 2);
        if (split.length == 2){
            var key = split[0].toLowerCase();
            result[key] = split[1];
        }
    }
    return result;
}

/**
 *
 * @param {XMLHttpRequest} XHR
 * @returns {RawResponse|null}
 * @ignore
 */
function getRawResponse(XHR) {
    try {
        return new RawResponse(
            JSON.parse(XHR.responseText),
            XHR.status,
            XHR.statusText,
            getHeadersFromXHR(XHR)
        );
    } catch (e) {
        return null;
    }
}
/**
 *
 * @param XHR
 * @returns {ErrorResponse}
 * @ignore
 */
function getErrorResponse(XHR) {
    return new ErrorResponse(
        XHR.responseText,
        XHR.status,
        XHR.statusText,
        getHeadersFromXHR(XHR)
    );
}

// &lt;/editor-fold&gt;

/**
 * Process requests using JSONP.
 * Browsers allow this method for cross-domain calls, but only GET requests.
 * @extends AbstractRequestAdapter
 * @memberOf module:api/request/adapter
 */
class XMLHttpRequestAdapter extends AbstractRequestAdapter {
    /**
     * Submit a request
     * @param {string} method
     * @param {string} url
     * @param {Object} [data]
     * @returns {Promise}
     */
    request(method, url, data=null){
        return new Promise((resolve, reject)=&gt;{
            var XHR = new XMLHttpRequest();

            XHR.addEventListener(&apos;load&apos;, ()=&gt;{
                var response = getRawResponse(XHR);
                if (response) {
                    resolve(response);
                } else {
                    reject(getErrorResponse(XHR));
                }
            });

            XHR.addEventListener(&apos;error&apos;, (event)=&gt;{
                console.log(&apos;XMLHttpRequestAdapter error&apos;, event, XHR);
                reject(event); // TODO Handle
            });
            XHR.addEventListener(&apos;timeout&apos;, (event)=&gt;{
                console.log(&apos;XMLHttpRequestAdapter timeout&apos;, event, XHR);
                reject(event); // TODO Handle
            });
            // XHR.addEventListener(&apos;abort&apos;, (event)=&gt;{
            //     console.log(&apos;XMLHttpRequestAdapter abort&apos;, event, XHR);
            //     reject(event);
            // });

            try {
                XHR.open(method, url);
                XHR.setRequestHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
                if (AuthService.oauthSession){
                    //TODO Add refresh
                    XHR.setRequestHeader(&quot;Authorization&quot;, AuthService.oauthSession.toHeaderString());
                }
                XHR.send(data ? JSON.stringify(data) : null);
            }catch(e){
                console.log(&apos;XMLHttpRequestAdapter exception&apos;, e);
                reject(e);
            }
        });
    }

    // &lt;editor-fold desc=&quot;Wrapped Requests&quot;&gt;

    /**
     * Submit a GET request
     * @param {string} url
     * @param {Object} data
     * @returns {Promise}
     */
    get(url, data){
        return this.request(&apos;GET&apos;, this.addToQueryString(url, data));
    }

    /**
     * Submit a POST request
     * @param {string} url
     * @param {Object} data
     * @returns {Promise}
     */
    post(url, data){
        return this.request(&apos;POST&apos;, url, data);
    }

    /**
     * Submit a PUT request
     * @param {string} url
     * @param {Object} data
     * @returns {Promise}
     */
    put(url, data){
        return this.request(&apos;PUT&apos;, url, data);
    }

    /**
     * Submit a DELETE request
     * @param {string} url
     * @param {Object} data
     * @returns {Promise}
     */
    del(url, data){
        return this.request(&apos;DELETE&apos;, url, data);
    }

    // &lt;/editor-fold&gt;
}

// Return single instance, making it a singleton
export default new XMLHttpRequestAdapter();
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
